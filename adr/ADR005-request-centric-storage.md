# ADR005: Request-Centric Storage

### Status
Accepted

---

### Context
OPA(Open Policy Agent)는 정책 평가 결과를 decision log 형태로 전달

기존 POC에서는 이 decision log를 기반으로, 정책(policy)과 규칙(rule) 중심으로 데이터를 분리하여 저장하는 구조를 사용
이 구조는 정책 평가 결과를 세부적으로 분석하는 데에는 유용했지만, 운영 환경에서 요청 단위로 디버깅을 진행하기에는 불편함

---

### Legacy: 정책 중심 저장

- 정책(policy), 규칙(rule), 위반(violation)을 분리된 테이블로 저장
- 정책별 통과/실패 여부를 중심으로 구조화
- 일부 필드는 JSON 형태로 저장하되, 핵심 결과는 컬럼으로 분리

#### 장점
- 정책/규칙 단위 분석 및 조회에 유리
- SQL을 통한 정책별 실패 원인 추적 가능

#### 한계
- 하나의 접근 요청에 대한 판단 결과를 파악하려면 여러 테이블을 조합해야 함
- 운영자가 “이 요청이 왜 거절되었는지”를 빠르게 이해하기 어려움
- 정책 구조 변경 시 저장 스키마와 파이프라인이 함께 변경될 가능성 존재

### Improved: 요청 중심 저장

- decision 단위로 원본 decision log를 그대로 저장 (raw JSON)
- 조회 및 필터에 필요한 최소 필드만 컬럼으로 분리
- 정책/규칙 결과의 재배치는 조회 시점에 수행

#### 장점
- 하나의 요청에 대한 판단 결과를 한 번에 파악 가능
- 정책 구조 변경에 유연하게 대응 가능
- 원본 로그를 보존한 상태에서 다양한 재배치 방식 실험 가능

#### 트레이드 오프
- 정책/규칙 단위의 직접적인 SQL 분석에는 적합하지 않음
- 요청 단위 Context 구성 로직이 서버 코드에 포함됨

---

### Decision
기존 저장 방식은 정책 평가 결과를 체계적으로 관리하는 데에는 적합했지만,
운영 디버깅 관점에서는 요청 단위의 맥락을 이해하기에 복잡한 구조였다.

개선된 저장 방식은 decision log를 요청 단위의 원본 데이터로 취급하고,
운영자가 판단 결과를 빠르게 이해할 수 있도록 재배치하는 데 초점을 둔다.
